<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="http://unpkg.com/tone"></script>
    <!-- Collega il file CSS esterno -->
    <link rel="stylesheet" href="style.css">
</head>


<body>
    <div class="container">
        <!-- Titolo della pagina -->
        <div class="title">Sei pronto per Jammare con JamMate? Carica o registra la melodia che ti passa per la testa.</div>
        <!-- Bottone per iniziare -->
        <button class="start-button" id="startBtn">Iniziamo</button>
        <!-- Sezione nascosta con bottoni per caricare o registrare un file -->
        <div class="upload-record-buttons" id="actionButtons">
            <button id="uploadBtn">Carica un file audio</button>
            <div>
                <button id="recordBtn">Registra la tua traccia dal microfono</button>
                <input type="checkbox" id="toggle-bpm" name="toggle-bpm">
                <label for="bpm">usa BPM per registrare:</label>
                <input type="number" id="select-bpm" name="bpm" min="70" max="180" value="120">
            </div>
        </div>
        <!-- Timer per la registrazione -->
        
    </div>

    <div class="container2" style="display: none;">
        <button id="backBtn" class="styled-button">Torna indietro</button>
        
    <div class="selection-row">
        <div class="selection-container">
            <h1>Con che generi vorresti sperimentare oggi?</h1>
            <div class="genres">
            <button class="btn genre-btn">Rap</button>
            <button class="btn genre-btn">Latin</button>
            <button class="btn genre-btn">Jazz</button>
            <button class="btn genre-btn">Pop</button>
            <button class="btn genre-btn">Funk</button>
            </div>
        </div>
        <div class="selection-container">
            <h1>Quanto lungo vuoi che sia il tuo loop?</h1>
            <div class="loop-length">
            <button class="btn loop-btn">4 Bars</button>
            <button class="btn loop-btn">8 Bars</button>
            <button class="btn loop-btn">16 Bars</button>
            </div>
        </div>
    </div>
    <div class="selection-row">
        <div class="selection-container">
            <h1>Quale chiave detectata si addice alla tua faccia di cazzo?</h1>
            <div class="keys">
                <button class="btn key-btn"></button>
                <button class="btn key-btn"></button>
            </div>
        </div>
        <div class="selection-container">
            <h1>Scegli l'algoritmo per individuare il battere</h1>
            <div class="onset-algorythm">
                <button class="btn algorithm-btn">Algoritmo A</button>
                <button class="btn algorithm-btn">Algoritmo B</button>
                <input id="threshold" type="number" min="0" max="1" step="0.01" value="0.5">
                <button class="btn algorithm-btn">Algoritmo C</button>
                <button id="info-algorithm" class="info-btn">i</button>
                <button id="change-onset" class="styled-button">change onset</button>
            </div>
        </div>
    </div>
        <!-- Pulsante JAM -->
        <button id= "jam-button" class="styled-button">JAM!</button>
        <div class="controls" style="display: none;">
            <button id="start_Btn" class="styled-button">Start</button>
            <button id="stop_Btn" class="styled-button">Stop</button>
        </div>
        <div id="try"></div>

        <div class="container3">
            <div class="wavecontainer">
                <div id="melodyWaveform" class="waveform"></div>
                <div class="slidercontainer">
                    <div class="number">50</div>
                    <input type="range" min="0" max="100" value="50" class="slider" data-type="melody" data-param="volume">
                    <div class="label">Volume</div>
                </div>
                <div class="slidercontainer">
                    <div class="number">0</div>
                    <input type="range" min="0" max="100" value="0" class="slider" data-type="melody" data-param="reverb">
                    <div class="label">Reverb</div>
                </div>
                <div class="slidercontainer">
                    <div class="number">0</div>
                    <input type="range" min="0" max="100" value="0" class="slider" data-type="melody" data-param="delay">
                    <div class="label">Delay</div>
                </div>
            </div>
            <div class="wavecontainer">
                <div id="drumWaveform" class="waveform"></div>
                <div class="slidercontainer">
                    <div class="number">50</div>
                    <input type="range" min="0" max="100" value="50" class="slider" data-type="drum" data-param="volume">
                    <div class="label">Volume</div>
                </div>
                <div class="slidercontainer">
                    <div class="number">0</div>
                    <input type="range" min="0" max="100" value="0" class="slider" data-type="drum" data-param="reverb">
                    <div class="label">Reverb</div>
                </div>
                <div class="slidercontainer">
                    <div class="number">0</div>
                    <input type="range" min="0" max="100" value="0" class="slider" data-type="drum" data-param="delay">
                    <div class="label">Delay</div>
                </div>
            </div>
            <div class="wavecontainer">
                <div id="bassWaveform" class="waveform"></div>
                <div class="slidercontainer">
                    <div class="number">50</div>
                    <input type="range" min="0" max="100" value="50" class="slider" data-type="bass" data-param="volume">
                    <div class="label">Volume</div>
                </div>
                <div class="slidercontainer">
                    <div class="number">0</div>
                    <input type="range" min="0" max="100" value="0" class="slider" data-type="bass" data-param="reverb">
                    <div class="label">Reverb</div>
                </div>
                <div class="slidercontainer">
                    <div class="number">0</div>
                    <input type="range" min="0" max="100" value="0" class="slider" data-type="bass" data-param="delay">
                    <div class="label">Delay</div>
                </div>
            </div>
    </div>
</div>


<div id="bpmInfoContainer" class="infoContainer">
    <button id="backToMainBpm" class="backBtn styled-button">Torna Indietro</button>
    <h2 class="titleInfo">BPM Detection</h2>
    <div class="paragraph">
        <ul>
            The algorithm receives an audio buffer containing the sound data.<br><br>
            <li>It finds the peaks: The algorithm divides the audio into small "parts" and identifies volume peaks for each part.</li>
            <li>For each peak, the algorithm calculates the interval between that peak and the nearest peaks.</li>
        </ul>
    </div>
    <div class="image"><img src="images/bpm1.png" alt="Image"></div>
    <div class="image"><img src="images/bpm2.png" alt="Image"></div>
    <div class="paragraph">
        <ul>
            Each interval represents a potential beat of the song and is stored in an object called a "group," which stores:<br><br>
            <li>The BPM calculated from the interval.</li>
            <li>The occurrences of intervals with the same duration.</li>
            <li>An array of the peaks that generated these intervals (this is used for a "type C" algorithm to identify the beat of the melody, which we will encounter later in jamMate).</li>
            The final BPM is determined by selecting the group with the most frequent BPM value.
        </ul>
    </div>
</div>
    


<div id="keyInfoContainer" class="infoContainer">
  <button id="backToMainKey" class="backBtn styled-button">Torna Indietro</button>
  <h2 class="titleInfo">
    Key Detection<br><br>The key_detection algorithm is based on the chroma vector of the input audio, computed with the STFT. The frequency content is analyzed to determine the corresponding pitch class. By examining the occurrences of each pitch class, the key is determined using predefined ‘key profiles’.
  </h2>
  <div class="secondaryKeyContainer">
    <div class="paragraph">
      HOW TO GET THE NOTES OF A SONG:

Chroma (audioBuffer, fft, fftSize):
1.  Compute the STFT of the input audio buffer
    (fs = 44.1k, N = 4096, Hop = 2048 )
2.  Loop: for each window , 
    -  spectrum = fft.spectrum  //obtain the magnitude spectrum
                                
    -  calculateChromaVector (spectrum)
    -  chromaData.push (chromaVector)
3.  return chromaData

CalculateChromaVector (spectrum, sampleRate):
1.  binsize = sampleRate / spectrum.length  // frequency resolution               
                                                                   
2.  Loop: for i from 0 to spectrum.length/2  
    -  frequency = i * binSize

    //calculation of the corresponding pitch class (C, …)
    -  pitchclass = (12*(log2(frequency/440))+12+9))%12 

    //magnitude corresponding to the frequency
    -  chromaVector[pitchClass] += spectrum[i]   
3.  return chromaVector  

ExtractNotesFromChroma(chromaData):
1.  forEach chromaVector in chromaData:

    //index corresponding to the max value
    -  max_index = math.max(chromavector)  
2.  notes.push(noteNames [ max_index ] )
3.  return notes // array containing the most relevant note for each window
    
    </div>
  </div>
  <div class="secondaryKeyContainer">
    <div class="paragraph">

      ONCE WE HAVE THE NOTES, HOW CAN WE DETECT THE KEY?

DetectKey(notes): 
Inspired by Krumhansl-Schmuckler key-finding algorithm, based on ‘key profiles’. 
A key profile is a vector of 12 values, representing the stability of the 12 pitch classes relative to a given key. 
These key profiles were obtained from experiments by Krumhansl in which subjects were asked to rate how well each pitch class “fit with” a prior context representing a key (usually a scale). 
A high value means that the corresponding pitch class was judged to fit well with a given key. 
The image shows (for the C major and minor scale) how much weight each note has for key recognition.
The algorithm works as follows: 
    </div>
    <div class="image">
      <img src="images/key1.png" alt="Image">
    </div>
    <div class="paragraph">
      
noteNames = [ C, C#, D, D#, E, F, F#, G, G#, A, A#, B ] 

1. forEach note in notes :
   - index = noteNames.indexOf(note)
   - noteCounts[index]++ ;   //occurrences of each pitchClass of the whole audio signal
2. Loop: for p from 0 to 11  // for each pitchClass
   - Shift a dx di major profile e minor profile di p
- Dot product between noteCounts and major profile //calculation of the similarity of two vectors
- Dot product between noteCounts and minor profile
   - Se majorCorrelation > bestMajorCorrelation : 
      a. bestMajorCorrelation = majorCorrelation
      b. bestMajorKey = noteNames [i] + ‘Major’
   - Se minorCorrelation > bestMinorCorrelation :
      c. bestMinorCorrelation = minorCorrelation
      d. bestMinorKey = noteNames [i] + ‘Minor’
3. return detectedkeys.push(bestMajorKey, bestMinorKey)
      
    </div>
  </div>
</div>


    <!-- Collega il file JavaScript esterno -->
    <script src="https://unpkg.com/wavesurfer.js"></script>
    <script src="https://unpkg.com/tone"></script>
    <script src="libs/dsp.js"></script>
    <script type="module" src="script.js"></script>
</body>
</html>
